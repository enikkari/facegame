<html>
<head>
	<script src="/static/jquery.min.js"></script>
	<script src="/static/jquery.form.js"></script>

	<script type='text/javascript' src='/static/jquery.tipsy.js'></script>
	<link rel="stylesheet" href="/static/tipsy.css" type="text/css" />
	
	<script type="text/javascript">
	var rnCorrect = "{{ rncorrect }}";
	var correctAnswers = 0;
	var wrongAnswers = 0;
	var currentStreak = 0;
	var highestStreak = 0;
	var skips = 0;
	var skippable = true;
	var mute = false;
	var tooltips = false;

	jQuery.preloadImages = function()
	{
		for(var i = 0; i<arguments.length; i++)
		{
			jQuery("<img>").attr("src", arguments[i]);   
		} 
	}

	$(document).ready(function()
	{
		$.preloadImages("/static/images/loader.gif");

		soundHandle1 = document.getElementById('soundHandle1');
		soundHandle2 = document.getElementById('soundHandle2');
		$("#soundHandle1").attr('preload', 'auto');
		$("#soundHandle2").attr('preload', 'auto');
		soundHandle1.src = '/static/sounds/correct.ogg';
		$(soundHandle1).bind("ended", function()
		{
			$('#nameform').submit();
		});
		soundHandle2.src = '/static/sounds/wrong.ogg';

		$('.muteimg').bind("click", function(event)
		{
			if (mute == true)
			{
				mute = false;
				$('.muteimg').attr('src', '/static/images/muteoff.png');
			} else
			{
				mute = true;
				$('.muteimg').attr('src', '/static/images/muteon.png');
			}
		});

		$('.helpimg').bind("click", function(event)
		{
			toggleTooltips();
		});

		$('.correctimg').tipsy({trigger: 'manual', html: true, gravity: 'n'});
		$('.wrongimg').tipsy({trigger: 'manual', html: true, gravity: 'se'});
		$('.skipimg').tipsy({trigger: 'manual', html: true, gravity: 'nw'});
		$('.muteimg').tipsy({trigger: 'manual', html: true, gravity: 's'});
		$('.helpimg').tipsy({trigger: 'manual', html: true, gravity: 'w'});

		initialize();
	});

	function response(responseText)
	{
		$('#face').fadeOut(400, function()
		{
			$('#output').css("display", "none");
			$('#output').html(responseText);
			rnCheck();
			initialize();
		});
	}

	function toggleTooltips()
	{
		if (tooltips == false)
		{
			$('.correctimg').tipsy("show");
			$('.wrongimg').tipsy("show");
			$('.skipimg').tipsy("show");
			$('.muteimg').tipsy("show");
			$('.helpimg').tipsy("show");
			tooltips = true;
			return false;
		} else
		{
			$('.correctimg').tipsy("hide");
			$('.wrongimg').tipsy("hide");
			$('.skipimg').tipsy("hide");
			$('.muteimg').tipsy("hide");
			$('.helpimg').tipsy("hide");
			tooltips = false;
			return false;
		}
	}

	function initialize()
	{
		$('.skipimg').fadeTo(500, 1.0);
		$('#face').load(function()
		{
			$('#output').fadeIn(700);
			$('#nameform').attr("disabled", false);
		}).each(function()
		{
			if(this.complete) $(this).trigger("load");
		});

		$('li').mouseenter(function(event)
		{
			$(this).css("background-color", "#BFBAA4");
		}).mouseleave(function(event)
		{
			$(this).css("background-color", "#FFFFFF");
		});

		$('.skipimg').click(function(event)
		{
			$(this).fadeTo(500, 0.3).unbind('click');
			$("li").unbind('click');
			skips += 1;
			currentStreak = 0;
			$('li').find("input[value=" + rnCorrect + "]").attr("checked", "checked");
			$('#nameform').fadeOut(600);
			$('#face').fadeOut(600, function()
			{
				$(this).attr('src', '/static/images/loader.gif');
				$(this).fadeIn(400);
			});
			$('#nameform').submit();
			return false;
		});

		$('li').click(function(event)
		{
			if ($(this).find("input[type=radio]").val() == rnCorrect)
			{
				if (mute == false)
				{
					soundHandle1.load();
					soundHandle1.play();
				}
				$("li").unbind('click');
				$(".skipimg").fadeTo(500, 0.3).unbind('click');
				correctAnswers += 1;
				currentStreak += 1;
				if (currentStreak > highestStreak)
				{
					highestStreak = currentStreak;
				}
				if (skippable == true)
				{
					skippable = false;
				}
				$('#correctnum').html(correctAnswers);
				$(this).find("input[type=radio]").attr("checked", "checked");
				$('#nameform').fadeOut(600);
				$('#face').fadeOut(600, function()
				{
					$(this).attr('src', '/static/images/loader.gif');
					$(this).fadeIn(400);
				});
				$(".correctimg").animate({"width": "+=6px", "height": "+=6px"}, 300, function()
				{
					$(".correctimg").animate({"width": "-=6px", "height": "-=6px"}, 350);					
				});
				if (mute == true)
				{
					$('#nameform').submit();
				}
				return false;
			}
			else
			{
				if (mute == false)
				{
					soundHandle2.load();
					soundHandle2.play();
				}
				$(this).unbind('click');
				$(".skipimg").fadeTo(500, 0.3).unbind('click');
				wrongAnswers += 1;
				if (skippable == true)
				{
					skippable = false;
				}
				$('#wrongnum').html(wrongAnswers);
				currentStreak = 0;
				$(this).fadeTo(700, 0.35);
				$(".wrongimg").animate({"width": "+=5px", "height": "+=5px"}, 300, function()
				{
					$(".wrongimg").animate({"width": "-=5px", "height": "-=5px"}, 350);
				});
				return false;
			}
		});

		var options = {target: '#output', success: response};
		$('#nameform').ajaxForm(options);
	}
	</script>
	
	<style type="text/css">
		ul {
		list-style: none;
		}
		
		input[type="radio"] {
		display: none;
		}
		
		.names {
		font-family: arial;
		font-size: 30px;
		line-height: 75px;
		}

		.logotxt {
		font-family: arial;
		font-size: 31px;
		color: #7F7B67;
		line-height: 0%;
		}

		.scoretxt {
		font-family: arial;
		font-size: 19px;
		color: #7F7B67;
		}

		.correctimg, .wrongimg, .skipimg, .muteimg, .helpimg {
		vertical-align: middle;
		}

		#output {
 		display: none;
		}
	</style>
	
	<title>Futufaces</title>
</head>
<body>
<audio id="soundHandle1" style="display: none;"></audio>
<audio id="soundHandle2" style="display: none;"></audio>
<table cellspacing="8px" align="center">
	<tr>
		<td>
			<img alt="futurice logo" src="/static/images/logo.png">
		</td>
		<td valign="bottom">
			<p class="logotxt">
				Futurice Facegame
			</p>
			<div id="scoretxt" class="scoretxt">
				<img alt="correct" title="correct answers" src="/static/images/correct.gif" class="correctimg">
					<span id="correctnum">0</span>
				<img alt="wrong" title="wrong answers" src="/static/images/wrong.gif" class="wrongimg">
					<span id="wrongnum">0</span>
				<img alt="skip" title="skip<br>(use if no photo)" src="/static/images/skip.png" class="skipimg">
				<img alt="mute" title="mute/unmute" src="/static/images/muteoff.png" class="muteimg">
				<img alt="help" title="toggle help" src="/static/images/help.png" class="helpimg">
			</div>
		</td>
	</tr>
</table>
<div id="output">
<table cellspacing="35px" align="center" id="gametable">
	<tr>
		<td align="right">
			<form id="nameform" method="post">{% csrf_token %}
			<font class="names">
			{{ form.name }}
			</font>
			</form>
			</td>
		<td align="left">
			<img id="face" src="{% url fumapi:user_photo rncorrect %}">
		</td>
	</tr>
</table>
</div>
</body>
</html>
